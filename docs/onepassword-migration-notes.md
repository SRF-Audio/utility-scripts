# Migration Notes: OnePassword CRD Requirements

This document tracks applications that require OnePassword CRD configuration before they can be fully deployed via the GitOps root app.

## Applications Requiring OnePassword Configuration

### 1. Tailscale Operator (`argocd/apps/operators/tailscale-operator.yml`)

**Status**: Needs OnePassword CRDs

**Current State**: Previously deployed via `tailscale_operator_deploy` role which templated OAuth credentials directly into the Helm values.

**Required Secrets**:
- `tailscale_oauth_client_id`
- `tailscale_oauth_client_secret`

**Migration Path**:
1. Create a `k8s/tailscale_operator/onepassword/` directory
2. Add OnePasswordItem CRDs for the OAuth credentials
3. Update `tailscale-operator.yml` to reference the secret created by the OnePassword operator
4. Remove placeholder values from the application manifest

**Sync Wave**: 0 (operator)

---

### 2. Synology CSI (`argocd/apps/platform/synology-csi.yml`)

**Status**: Needs OnePassword CRDs

**Current State**: Previously deployed via `synology_csi_deploy` role which templated NAS credentials into the Helm values.

**Required Secrets**:
- `synology_csi_deploy_nas_lan_ip` (NAS host IP address)
- `k3s_synology_csi_nas_username` (NAS username)
- `k3s_synology_csi_nas_password` (NAS password)
- `synology_csi_deploy_nfs_storage_path` (NFS storage path on NAS)

**Migration Path**:
1. Create OnePasswordItem CRDs for NAS credentials
2. Either:
   - Create a `k8s/synology_csi_secrets/` directory for OnePassword CRDs, OR
   - Since this is Helm-only, create `argocd/apps/platform/synology-csi_secrets/` directory
3. Update `synology-csi.yml` to reference the secret
4. Remove placeholder values from the application manifest

**Sync Wave**: 20 (platform service)

---

### 3. Homepage (`argocd/apps/platform/homepage.yml`)

**Status**: Needs OnePassword CRDs + ArgoCD Token Management

**Current State**: Previously deployed via `homepage_deploy` role which:
1. Templated NextDNS and Proxmox API credentials into Helm values
2. Used `argocd_homepage_token` role to generate an ArgoCD API token
3. Applied the token as a secret via templated manifests

**Required Secrets**:
- `homepage_nextdns_api_token` (NextDNS API key)
- `proxmox_api_password` (Proxmox API password)
- ArgoCD API token (currently generated by `argocd_homepage_token` role)

**Migration Path**:
1. Create OnePasswordItem CRDs for:
   - NextDNS API token
   - Proxmox API password
2. For ArgoCD token:
   - **Option A**: Create a static token in ArgoCD and store in 1Password
   - **Option B**: Keep `argocd_homepage_token` role in bootstrap phase and create the secret before root app deployment
   - **Option C**: Use ArgoCD's native token management and reference it in the homepage deployment
3. Create either `k8s/homepage/onepassword/` or `argocd/apps/platform/homepage_secrets/`
4. Update `homepage.yml` to use `valuesObject` with secret references instead of direct values
5. Remove placeholder values from the application manifest

**Sync Wave**: 30 (application workload)

---

## General Migration Pattern

For each application requiring secrets:

1. **Choose deployment method**:
   - If using `k8s/<app>/` for manifests → place OnePassword CRDs in `k8s/<app>/onepassword/`
   - If using Helm-only → create `argocd/apps/<tier>/<app>_secrets/` directory

2. **Create OnePasswordItem CRDs**:
   ```yaml
   apiVersion: onepassword.com/v1
   kind: OnePasswordItem
   metadata:
     name: <app>-secrets
     namespace: <app-namespace>
   spec:
     itemPath: "vaults/<vault>/items/<item-id>"
   ```

3. **Update Application manifests**:
   - For secrets applications: set sync wave to **10**
   - For the main application: set sync wave to **20** (platform) or **30** (apps)
   - Configure application to consume secrets via Kubernetes Secret references

4. **Test deployment order**:
   - Verify secrets are created in wave 10
   - Verify application deploys successfully in later wave

## Reference: Crafty Controller (Already Migrated)

See `k8s/crafty_controller/onepassworditem-crafty-default-json.yml` and `argocd/apps/apps/crafty-controller.yml` for a working example of OnePassword CRD integration.

## Status Tracking

| Application | OnePassword CRDs | Application Updated | Tested | Notes |
|-------------|-----------------|---------------------|--------|-------|
| Tailscale Operator | ❌ | ❌ | ❌ | Requires OAuth credentials |
| Synology CSI | ❌ | ❌ | ❌ | Requires NAS credentials |
| Homepage | ❌ | ❌ | ❌ | Requires multiple API keys + ArgoCD token |
| Crafty Controller | ✅ | ✅ | ❓ | Already using OnePassword CRDs |
| Omada Controller | ✅ | ✅ | ❓ | No secret dependencies |
| Paperless NGX | ✅ | ✅ | ❓ | Already using OnePassword CRDs |
| NFS Provisioner | ✅ | ✅ | ❓ | No secret dependencies |
| Cluster Primitives | ✅ | ✅ | ❓ | No secret dependencies |
| PostgreSQL | ✅ | ✅ | ❓ | Already using OnePassword CRDs |
| Redis | ✅ | ✅ | ❓ | Already using OnePassword CRDs |
