apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-pv-migration
  namespace: db-postgres
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsUser: 0
        runAsGroup: 0
      containers:
        - name: migrate
          image: alpine:3.20
          command:
            - /bin/sh
            - -ec
            - |
              apk add --no-cache rsync coreutils findutils

              SRC=/src
              DST=/dst/db-postgres/data-postgres-postgresql-0

              echo "== Preflight =="
              test -d "$SRC" || (echo "Missing $SRC" && exit 1)
              mkdir -p "$DST"

              echo "== Source summary =="
              find "$SRC" -xdev -type f | wc -l
              du -sh "$SRC" || true

              echo "== Destination pre-summary =="
              find "$DST" -xdev -type f 2>/dev/null | wc -l || true
              du -sh "$DST" 2>/dev/null || true

              echo "== Copy =="
              rsync -aH --numeric-ids --info=progress2 "$SRC"/ "$DST"/

              echo "== Verify counts (basic) =="
              SRC_COUNT=$(find "$SRC" -xdev -type f | wc -l | tr -d ' ')
              DST_COUNT=$(find "$DST" -xdev -type f | wc -l | tr -d ' ')
              echo "SRC files: $SRC_COUNT"
              echo "DST files: $DST_COUNT"
              test "$SRC_COUNT" = "$DST_COUNT" || (echo "File count mismatch" && exit 2)

              echo "== Verify key Postgres marker =="
              test -f "$DST/data/PG_VERSION" || (echo "Missing PG_VERSION in dst/data" && exit 3)

              echo "== Done =="
          volumeMounts:
            - name: src
              mountPath: /src
            - name: dst
              mountPath: /dst
      volumes:
        - name: src
          persistentVolumeClaim:
            claimName: data-postgres-postgresql-0
        - name: dst
          nfs:
            server: 192.168.226.6
            path: /volume2/k3s-cluster-storage
