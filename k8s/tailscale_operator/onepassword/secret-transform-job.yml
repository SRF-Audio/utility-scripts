---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-transformer
  namespace: infra-tailscale-operator
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-transformer
  namespace: infra-tailscale-operator
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-transformer
  namespace: infra-tailscale-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: secret-transformer
subjects:
  - kind: ServiceAccount
    name: secret-transformer
    namespace: infra-tailscale-operator
---
apiVersion: batch/v1
kind: Job
metadata:
  name: transform-tailscale-secret
  namespace: infra-tailscale-operator
  annotations:
    argocd.argoproj.io/sync-wave: "11"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: secret-transformer
      restartPolicy: OnFailure
      containers:
        - name: transform
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Waiting for source secret to be available..."
              SECRET_NAME="tailscale-operator-oauth"
              NS="infra-tailscale-operator"
              until kubectl get secret $SECRET_NAME -n $NS 2>/dev/null; do
                echo "Secret not found, waiting..."
                sleep 5
              done

              echo "Extracting credentials from source secret..."
              CLIENT_ID=$(kubectl get secret $SECRET_NAME -n $NS \
                -o jsonpath='{.data.tailscale_oauth_client_id}')
              CLIENT_SECRET=$(kubectl get secret $SECRET_NAME -n $NS \
                -o jsonpath='{.data.tailscale_oauth_client_secret}')

              if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
                echo "ERROR: Could not extract credentials"
                exit 1
              fi

              echo "Creating operator-oauth secret..."
              kubectl create secret generic operator-oauth \
                --from-literal=client_id=$(echo "$CLIENT_ID" | base64 -d) \
                --from-literal=client_secret=$(
                  echo "$CLIENT_SECRET" | base64 -d) \
                --namespace=$NS \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "Secret transformation completed successfully!"
