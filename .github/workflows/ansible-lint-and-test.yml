name: Ansible â€“ Lint and Test

on:
  pull_request:
    paths:
      - "ansible/**"
      - ".github/workflows/ansible-lint-and-test.yml"
  push:
    branches:
      - main
    paths:
      - "ansible/**"
      - ".github/workflows/ansible-lint-and-test.yml"
  workflow_dispatch:

jobs:
  ansible-yamllint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Normalize repo name to lowercase
        id: normalize
        run: |
          echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set tooling image
        id: image
        run: |
          echo "IMAGE=ghcr.io/${{ steps.normalize.outputs.REPO_LOWER }}/fedora-43-homelab-tooling:latest" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run yamllint inside tooling container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.image.outputs.IMAGE }}
          options: |
            -v ${{ github.workspace }}:/workspace
            --pull=always
          run: |
            pip install --quiet yamllint
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "Manual trigger: Running yamllint on all Ansible YAML files..."
              yamllint ansible/
            else
              echo "Running yamllint on changed Ansible YAML files..."
              git diff --name-only --diff-filter=ACMRT ${{ github.event.before || 'origin/main' }} ${{ github.sha }} | grep -E '^ansible/.*\.(yml|yaml)$' | grep -v '^ansible/old_roles/' | xargs -r yamllint || echo "No files to lint"
            fi

  ansible-lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Normalize repo name to lowercase
        id: normalize
        run: |
          echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set tooling image
        id: image
        run: |
          echo "IMAGE=ghcr.io/${{ steps.normalize.outputs.REPO_LOWER }}/fedora-43-homelab-tooling:latest" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run ansible-lint inside tooling container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.image.outputs.IMAGE }}
          options: |
            -v ${{ github.workspace }}:/workspace
            --pull=always
          run: |
            ansible-galaxy collection install -r ansible/requirements.yml
            pip install --quiet ansible-lint
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "Manual trigger: Running ansible-lint on all roles and playbooks..."
              ansible-lint ansible/playbooks/ ansible/roles/ ansible/site.yml --exclude ansible/old_roles/
            else
              echo "Running ansible-lint on changed files..."
              changed_files=$(git diff --name-only --diff-filter=ACMRT ${{ github.event.before || 'origin/main' }} ${{ github.sha }} | grep -E '^ansible/(roles|playbooks)/.*\.(yml|yaml)$|^ansible/site\.yml$' | grep -v '^ansible/old_roles/' || true)
              if [ -n "$changed_files" ]; then
                echo "$changed_files" | xargs ansible-lint
              else
                echo "No files to lint"
              fi
            fi

  ansible-playbook-syntax:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    strategy:
      fail-fast: false
      matrix:
        playbook:
          - ansible/playbooks/audio-production.yml
          - ansible/playbooks/coachlight-infra-stack.yml
          - ansible/playbooks/file_copier_examples.yml
          - ansible/playbooks/k3s-cluster-setup.yml
          - ansible/playbooks/omada-netbox-sync.yml
          - ansible/playbooks/omada-tester.yml
          - ansible/playbooks/op_tester.yml
          - ansible/playbooks/proxmox.yml
          - ansible/playbooks/tailscale_tester.yml
          - ansible/playbooks/workstations.yml
          - ansible/site.yml

    steps:
      - name: Normalize repo name to lowercase
        id: normalize
        run: |
          echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set tooling image
        id: image
        run: |
          echo "IMAGE=ghcr.io/${{ steps.normalize.outputs.REPO_LOWER }}/fedora-43-homelab-tooling:latest" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if playbook changed
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            if git diff --name-only --diff-filter=ACMRT ${{ github.event.before || 'origin/main' }} ${{ github.sha }} | grep -q "^${{ matrix.playbook }}$"; then
              echo "run=true" >> $GITHUB_OUTPUT
            else
              echo "run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run syntax check on ${{ matrix.playbook }}
        if: steps.check.outputs.run == 'true'
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.image.outputs.IMAGE }}
          options: |
            -v ${{ github.workspace }}:/workspace
            --pull=always
          run: |
            ansible-galaxy collection install -r ansible/requirements.yml
            echo "Checking syntax for ${{ matrix.playbook }}..."
            ansible-playbook ${{ matrix.playbook }} --syntax-check
