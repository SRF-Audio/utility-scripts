name: Ansible â€“ Lint and Test

on:
  pull_request:
    paths:
      - "ansible/**"
      - ".github/workflows/ansible-lint-and-test.yml"
  push:
    branches:
      - main
    paths:
      - "ansible/**"
      - ".github/workflows/ansible-lint-and-test.yml"
  workflow_dispatch:
    inputs:
      full_lint:
        description: 'Run full lint on all Ansible files'
        required: false
        type: boolean
        default: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      ansible_files: ${{ steps.set-outputs.outputs.ansible_files }}
      ansible_files_list: ${{ steps.set-outputs.outputs.ansible_files_list }}
      roles_changed: ${{ steps.detect-roles.outputs.roles }}
      playbooks_changed: ${{ steps.detect-playbooks.outputs.playbooks }}
      is_manual: ${{ steps.check-trigger.outputs.is_manual }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if manual trigger
        id: check-trigger
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "is_manual=true" >> $GITHUB_OUTPUT
          else
            echo "is_manual=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed Ansible files
        id: filter
        if: steps.check-trigger.outputs.is_manual == 'false'
        uses: tj-actions/changed-files@v44
        with:
          files: |
            ansible/**/*.yml
            ansible/**/*.yaml
          files_ignore: |
            ansible/old_roles/**

      - name: Set file change outputs
        id: set-outputs
        run: |
          if [ "${{ steps.check-trigger.outputs.is_manual }}" = "true" ]; then
            echo "ansible_files=true" >> $GITHUB_OUTPUT
            echo "ansible_files_list=" >> $GITHUB_OUTPUT
          else
            echo "ansible_files=${{ steps.filter.outputs.any_changed }}" >> $GITHUB_OUTPUT
            echo "ansible_files_list=${{ steps.filter.outputs.all_changed_files }}" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed roles
        id: detect-roles
        run: |
          if [ "${{ steps.check-trigger.outputs.is_manual }}" = "true" ]; then
            # Manual trigger: lint all roles
            roles=$(find ansible/roles -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | tr '\n' ' ')
            echo "roles=$roles" >> $GITHUB_OUTPUT
            echo "Manual trigger: Will lint all roles"
          elif [ "${{ steps.set-outputs.outputs.ansible_files }}" = "true" ]; then
            # Auto trigger: detect changed roles
            changed_files="${{ steps.set-outputs.outputs.ansible_files_list }}"
            roles=""
            for file in $changed_files; do
              if [[ "$file" =~ ^ansible/roles/([^/]+)/ ]]; then
                role="${BASH_REMATCH[1]}"
                if [[ ! "$roles" =~ (^|[[:space:]])"$role"($|[[:space:]]) ]]; then
                  roles="$roles $role"
                fi
              fi
            done
            roles=$(echo "$roles" | xargs)
            echo "roles=$roles" >> $GITHUB_OUTPUT
            echo "Changed roles: $roles"
          else
            echo "roles=" >> $GITHUB_OUTPUT
            echo "No changed roles detected"
          fi

      - name: Detect changed playbooks
        id: detect-playbooks
        run: |
          if [ "${{ steps.check-trigger.outputs.is_manual }}" = "true" ]; then
            # Manual trigger: check all playbooks
            playbooks=$(find ansible/playbooks -name "*.yml" -o -name "*.yaml" | sort | tr '\n' ' ')
            playbooks="$playbooks ansible/site.yml"
            echo "playbooks=$playbooks" >> $GITHUB_OUTPUT
            echo "Manual trigger: Will check all playbooks"
          elif [ "${{ steps.set-outputs.outputs.ansible_files }}" = "true" ]; then
            # Auto trigger: detect changed playbooks
            changed_files="${{ steps.set-outputs.outputs.ansible_files_list }}"
            playbooks=""
            for file in $changed_files; do
              if [[ "$file" =~ ^ansible/playbooks/.*\.(yml|yaml)$ ]] || [[ "$file" = "ansible/site.yml" ]]; then
                playbooks="$playbooks $file"
              fi
            done
            playbooks=$(echo "$playbooks" | xargs)
            echo "playbooks=$playbooks" >> $GITHUB_OUTPUT
            echo "Changed playbooks: $playbooks"
          else
            echo "playbooks=" >> $GITHUB_OUTPUT
            echo "No changed playbooks detected"
          fi

  ansible-yamllint:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ansible_files == 'true' || needs.detect-changes.outputs.is_manual == 'true'
    permissions:
      contents: read
      packages: read

    steps:
      - name: Normalize repo name to lowercase
        id: normalize
        run: |
          echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set tooling image
        id: image
        run: |
          echo "IMAGE=ghcr.io/${{ steps.normalize.outputs.REPO_LOWER }}/fedora-43-homelab-tooling:latest" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run yamllint inside tooling container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.image.outputs.IMAGE }}
          options: |
            -v ${{ github.workspace }}:/workspace
            --pull=always
          run: |
            pip install --quiet yamllint
            if [ "${{ needs.detect-changes.outputs.is_manual }}" = "true" ]; then
              echo "Running yamllint on all Ansible YAML files..."
              yamllint ansible/
            else
              echo "Running yamllint on changed Ansible YAML files..."
              changed_files="${{ needs.detect-changes.outputs.ansible_files_list }}"
              if [ -n "$changed_files" ]; then
                for file in $changed_files; do
                  echo "Linting: $file"
                done
                echo "$changed_files" | tr ' ' '\n' | xargs yamllint
              else
                echo "No files to lint"
              fi
            fi

  ansible-lint:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.roles_changed != '' || needs.detect-changes.outputs.playbooks_changed != '') ||
      needs.detect-changes.outputs.is_manual == 'true'
    permissions:
      contents: read
      packages: read

    steps:
      - name: Normalize repo name to lowercase
        id: normalize
        run: |
          echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set tooling image
        id: image
        run: |
          echo "IMAGE=ghcr.io/${{ steps.normalize.outputs.REPO_LOWER }}/fedora-43-homelab-tooling:latest" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run ansible-lint inside tooling container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.image.outputs.IMAGE }}
          options: |
            -v ${{ github.workspace }}:/workspace
            --pull=always
          run: |
            ansible-galaxy collection install -r ansible/requirements.yml
            pip install --quiet ansible-lint
            if [ "${{ needs.detect-changes.outputs.is_manual }}" = "true" ]; then
              echo "Running ansible-lint on all roles and playbooks..."
              ansible-lint ansible/playbooks/ ansible/roles/ ansible/site.yml --exclude ansible/old_roles/
            else
              echo "Running ansible-lint on changed roles and playbooks..."
              targets=""
              roles="${{ needs.detect-changes.outputs.roles_changed }}"
              playbooks="${{ needs.detect-changes.outputs.playbooks_changed }}"
              
              for role in $roles; do
                targets="$targets ansible/roles/$role"
              done
              
              for playbook in $playbooks; do
                targets="$targets $playbook"
              done
              
              if [ -n "$targets" ]; then
                echo "Linting: $targets"
                ansible-lint $targets
              else
                echo "No targets to lint"
              fi
            fi

  ansible-playbook-syntax-setup:
    runs-on: ubuntu-latest
    needs: detect-changes
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_playbooks: ${{ steps.set-matrix.outputs.has_playbooks }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          if [ "${{ needs.detect-changes.outputs.is_manual }}" = "true" ]; then
            # Manual trigger: check all playbooks
            matrix='["ansible/playbooks/audio-production.yml","ansible/playbooks/coachlight-infra-stack.yml","ansible/playbooks/file_copier_examples.yml","ansible/playbooks/k3s-cluster-setup.yml","ansible/playbooks/omada-netbox-sync.yml","ansible/playbooks/omada-tester.yml","ansible/playbooks/op_tester.yml","ansible/playbooks/proxmox.yml","ansible/playbooks/tailscale_tester.yml","ansible/playbooks/workstations.yml","ansible/site.yml"]'
            echo "matrix={\"playbook\":$matrix}" >> $GITHUB_OUTPUT
            echo "has_playbooks=true" >> $GITHUB_OUTPUT
            echo "Manual trigger: Will check all playbooks"
          else
            # Auto trigger: check only changed playbooks
            playbooks="${{ needs.detect-changes.outputs.playbooks_changed }}"
            if [ -n "$playbooks" ]; then
              # Convert space-separated list to JSON array
              json_array="["
              first=true
              for pb in $playbooks; do
                if [ "$first" = true ]; then
                  first=false
                else
                  json_array="$json_array,"
                fi
                json_array="$json_array\"$pb\""
              done
              json_array="$json_array]"
              echo "matrix={\"playbook\":$json_array}" >> $GITHUB_OUTPUT
              echo "has_playbooks=true" >> $GITHUB_OUTPUT
              echo "Changed playbooks matrix: $json_array"
            else
              # No playbooks changed, create empty matrix
              echo "matrix={\"playbook\":[]}" >> $GITHUB_OUTPUT
              echo "has_playbooks=false" >> $GITHUB_OUTPUT
              echo "No playbooks changed"
            fi
          fi

  ansible-playbook-syntax:
    runs-on: ubuntu-latest
    needs: ansible-playbook-syntax-setup
    if: needs.ansible-playbook-syntax-setup.outputs.has_playbooks == 'true'
    permissions:
      contents: read
      packages: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.ansible-playbook-syntax-setup.outputs.matrix) }}

    steps:
      - name: Normalize repo name to lowercase
        id: normalize
        run: |
          echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set tooling image
        id: image
        run: |
          echo "IMAGE=ghcr.io/${{ steps.normalize.outputs.REPO_LOWER }}/fedora-43-homelab-tooling:latest" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run syntax check on ${{ matrix.playbook }}
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.image.outputs.IMAGE }}
          options: |
            -v ${{ github.workspace }}:/workspace
            --pull=always
          run: |
            ansible-galaxy collection install -r ansible/requirements.yml
            echo "Checking syntax for ${{ matrix.playbook }}..."
            ansible-playbook ${{ matrix.playbook }} --syntax-check
