---
- name: Assert required frigate_deploy inputs are defined when applying
  ansible.builtin.assert:
    that:
      - frigate_deploy_kubeconfig is defined
      - frigate_deploy_context is defined
      - frigate_deploy_kubeconfig | string | length > 0
      - frigate_deploy_context | length > 0
    fail_msg: >-
      frigate_deploy_kubeconfig and frigate_deploy_context must be defined when frigate_deploy_apply_application is true.
  when: frigate_deploy_apply_application | bool

- name: Set frigate_deploy tmp directory path
  ansible.builtin.set_fact:
    frigate_deploy_tmp_dir: "{{ frigate_deploy_artifacts_path }}/frigate_deploy"
  when:
    - frigate_deploy_artifacts_path is defined
    - frigate_deploy_artifacts_path | length > 0

- name: Ensure frigate_deploy tmp directory exists
  ansible.builtin.file:
    path: "{{ frigate_deploy_tmp_dir }}"
    state: directory
    mode: "0755"
  when: frigate_deploy_tmp_dir is defined

- name: Render Frigate Argo CD Application manifest
  ansible.builtin.template:
    src: "{{ role_path }}/templates/frigate-application.yml.j2"
    dest: "{{ frigate_deploy_tmp_dir }}/frigate-application.yml"
    mode: "0644"
  register: frigate_deploy_application_file
  when: frigate_deploy_tmp_dir is defined

- name: Apply Frigate Argo CD Application manifest
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: "{{ frigate_deploy_kubeconfig }}"
    k8s_object_manager_context: "{{ frigate_deploy_context }}"
    k8s_object_manager_src: "{{ frigate_deploy_application_file.dest }}"
    k8s_object_manager_state: present
    k8s_object_manager_apply: true
  when:
    - frigate_deploy_apply_application | bool
    - frigate_deploy_application_file is defined
    - frigate_deploy_application_file.dest is defined

- name: Render Frigate Homepage ingress manifest
  ansible.builtin.template:
    src: "{{ role_path }}/templates/frigate-homepage-ingress.yml.j2"
    dest: "{{ frigate_deploy_tmp_dir }}/frigate-homepage-ingress.yml"
    mode: "0644"
  register: frigate_deploy_homepage_ingress_file
  when: frigate_deploy_tmp_dir is defined

- name: Apply Frigate Homepage ingress manifest
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: "{{ frigate_deploy_kubeconfig }}"
    k8s_object_manager_context: "{{ frigate_deploy_context }}"
    k8s_object_manager_src: "{{ frigate_deploy_homepage_ingress_file.dest }}"
    k8s_object_manager_state: present
    k8s_object_manager_apply: true
  when:
    - frigate_deploy_apply_application | bool
    - frigate_deploy_homepage_ingress_file is defined
    - frigate_deploy_homepage_ingress_file.dest is defined

- name: Persist frigate_deploy artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: "frigate_deploy"
    calling_role_artifacts_inputs:
      k3s_cluster_name: >-
        {{ frigate_deploy_cluster_name | default(k3s_cluster_name | default('', true), true) }}
      application_name: "frigate"
      argocd_namespace: "{{ frigate_deploy_argo_namespace }}"
      frigate_namespace: "{{ frigate_deploy_namespace }}"
      application_file: >-
        {{ frigate_deploy_application_file.dest | default('', true) }}
      homepage_ingress_file: >-
        {{ frigate_deploy_homepage_ingress_file.dest | default('', true) }}
  when:
    - frigate_deploy_artifacts_path is defined
    - frigate_deploy_artifacts_path | length > 0
