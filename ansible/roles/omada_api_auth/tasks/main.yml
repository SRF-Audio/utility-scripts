---
# roles/omada_api_auth/tasks/main.yml
- name: Assert required Omada API auth inputs are defined
  ansible.builtin.assert:
    that:
      - omada_api_base_url is defined
      - omada_api_username is defined
      - omada_api_password is defined
      - omada_api_base_url | length > 0
      - omada_api_username | length > 0
      - omada_api_password | length > 0
    fail_msg: "omada_api_base_url, omada_api_username, and omada_api_password must be defined for omada_api_auth."

- name: Get Omada controller info
  ansible.builtin.uri:
    url: "{{ omada_api_base_url }}/api/info"
    method: GET
    validate_certs: "{{ omada_api_validate_certs }}"
    return_content: true
    status_code: 200
  register: omada_api_info

- name: Set Omada controller id
  ansible.builtin.set_fact:
    omada_api_controller_id: "{{ omada_api_info.json.result.omadacId }}"

- name: Perform Omada API login via http_api_auth
  ansible.builtin.include_role:
    name: http_api_auth
  vars:
    http_api_name: "omada"
    http_api_base_url: "{{ omada_api_base_url }}/{{ omada_api_controller_id }}/api/v2"
    http_api_auth_path: "/login"
    http_api_method: "POST"
    http_api_body:
      username: "{{ omada_api_username }}"
      password: "{{ omada_api_password }}"
    http_api_validate_certs: "{{ omada_api_validate_certs }}"

- name: Assert Omada API login succeeded
  ansible.builtin.assert:
    that:
      - omada_auth_result.json.errorCode is defined
      - omada_auth_result.json.errorCode == 0
    fail_msg: "Omada API login failed. Check credentials and controller status."

- name: Set Omada API token, cookies, and base path
  ansible.builtin.set_fact:
    omada_api_token: "{{ omada_auth_result.json.result.token }}"
    omada_api_cookies: "{{ omada_auth_result.cookies_string | default('') }}"
    omada_api_base_path: "{{ omada_api_base_url }}/{{ omada_api_controller_id }}/api/v2"
