---
- name: Ensure CoreOS image download directory exists at {{ coreos_image_fetch_download_dir }}
  ansible.builtin.file:
    path: "{{ coreos_image_fetch_download_dir }}"
    state: directory
    mode: "0755"

- name: Check for existing Fedora CoreOS qcow2 images in {{ coreos_image_fetch_download_dir }}
  ansible.builtin.find:
    paths: "{{ coreos_image_fetch_download_dir }}"
    patterns: "*.qcow2"
    file_type: file
    recurse: false
  register: coreos_image_fetch_existing

- name: Download Fedora CoreOS image (stream={{ coreos_image_fetch_stream }}, platform={{ coreos_image_fetch_platform }})
  ansible.builtin.command:
    argv: >-
      {{
        [
          'coreos-installer', 'download',
          '--stream=' ~ coreos_image_fetch_stream,
          '--platform=' ~ coreos_image_fetch_platform,
          '--format=' ~ coreos_image_fetch_format,
          '--directory=' ~ coreos_image_fetch_download_dir,
          '--decompress'
        ]
        + (['--force'] if coreos_image_fetch_force_download | bool else [])
      }}
  when:
    - coreos_image_fetch_force_download | bool
      or coreos_image_fetch_existing.matched == 0
  register: coreos_image_fetch_download_cmd
  changed_when: coreos_image_fetch_download_cmd.rc == 0

- name: Locate Fedora CoreOS qcow2 image in {{ coreos_image_fetch_download_dir }}
  ansible.builtin.find:
    paths: "{{ coreos_image_fetch_download_dir }}"
    patterns: "*.qcow2"
    file_type: file
    recurse: false
  register: coreos_image_fetch_located

- name: Fail when Fedora CoreOS qcow2 image is missing in {{ coreos_image_fetch_download_dir }}
  ansible.builtin.fail:
    msg: >-
      No Fedora CoreOS qcow2 image found in {{ coreos_image_fetch_download_dir }}
  when: coreos_image_fetch_located.matched == 0

- name: Capture latest Fedora CoreOS image path from {{ coreos_image_fetch_download_dir }}
  ansible.builtin.set_fact:
    coreos_image_fetch_image_path: >-
      {{ (coreos_image_fetch_located.files | sort(attribute='mtime', reverse=true))[0].path }}

- name: Record CoreOS image fetch artifacts
  ansible.builtin.set_fact:
    coreos_image_fetch_artifacts:
      image_path: "{{ coreos_image_fetch_image_path }}"
      stream: "{{ coreos_image_fetch_stream }}"
      platform: "{{ coreos_image_fetch_platform }}"
      format: "{{ coreos_image_fetch_format }}"
      download_dir: "{{ coreos_image_fetch_download_dir }}"
      force_download: "{{ coreos_image_fetch_force_download | bool }}"

- name: Publish CoreOS image fetch artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    calling_role_name: coreos_image_fetch
    calling_role_artifacts_inputs: "{{ coreos_image_fetch_artifacts }}"
