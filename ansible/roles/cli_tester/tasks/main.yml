# roles/cli_tester/tasks/main.yml
- name: Assert cli_tester_cli_name is defined and non-empty
  ansible.builtin.assert:
    that:
      - cli_tester_cli_name is defined
      - cli_tester_cli_name | length > 0
    fail_msg: cli_tester_cli_name must be defined and non-empty.

- name: Check for 'which' command on {{ inventory_hostname }}
  ansible.builtin.command:
    cmd: "which which"
  register: cli_tester_which_check
  changed_when: false
  failed_when: false

- name: Set which ready fact on {{ inventory_hostname }}
  ansible.builtin.set_fact:
    cli_tester_which_ready: true
  when: cli_tester_which_check.rc == 0

- name: Ensure 'which' is installed on {{ inventory_hostname }}
  when: not (cli_tester_which_ready | default(false))
  block:
    - name: Gather OS facts for package installation
      ansible.builtin.setup:
        gather_subset:
          - '!all'
          - '!min'
          - distribution
          - pkg_mgr

    - name: Install which on RedHat-family with dnf/yum
      ansible.builtin.dnf:
        name: which
        state: present
      become: true
      when:
        - not (cli_tester_which_ready | default(false))
        - ansible_facts.os_family == 'RedHat'
        - ansible_facts.pkg_mgr in ['dnf', 'yum']

    - name: Install which on Debian-family with apt
      ansible.builtin.apt:
        name: which
        state: present
        update_cache: true
      become: true
      when:
        - not (cli_tester_which_ready | default(false))
        - ansible_facts.os_family == 'Debian'

    - name: Install which package on {{ inventory_hostname }}
      ansible.builtin.package:
        name: which
        state: present
      become: true
      when:
        - ansible_facts.os_family not in ['RedHat', 'Debian']

    - name: Mark 'which' as ready for cli_tester on {{ inventory_hostname }}
      ansible.builtin.set_fact:
        cli_tester_which_ready: true
  rescue:
    - name: Fail with sudo password hint if needed
      ansible.builtin.fail:
        msg: >
          Ensuring 'which' is installed failed because sudo requires a password.
          Rerun this playbook with the --ask-become-pass flag or configure passwordless privilege escalation.
      when: >
        'sudo: a password is required' in (ansible_failed_result.msg | default('')) or
        'sudo: a password is required' in (ansible_failed_result.stderr | default(''))

    - name: Fail due to unexpected error ensuring which is installed
      ansible.builtin.fail:
        msg: >
          Failed to verify or install 'which'. Underlying error:
          {{ ansible_failed_result | to_nice_json }}

- name: Test for CLI {{ cli_tester_cli_name }}
  ansible.builtin.command:
    cmd: "which {{ cli_tester_cli_name }}"
  register: cli_tester_cli_binary_check
  changed_when: false
  failed_when: false

- name: Set installed fact for {{ cli_tester_cli_name }}
  ansible.builtin.set_fact:
    cli_tester_is_cli_installed: "{{ cli_tester_cli_binary_check.rc == 0 }}"

- name: Pass cli_tester role artifacts for {{ cli_tester_cli_name }}
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    role_artifacts_path: "{{ cli_tester_artifacts_path }}"
    # noqa: var-naming
    calling_role_name: "cli_tester_{{ cli_tester_cli_name }}"
    calling_role_artifacts_inputs:
      cli_name: "{{ cli_tester_cli_name }}"
      is_cli_installed: "{{ cli_tester_is_cli_installed }}"
