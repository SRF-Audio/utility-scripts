---
- name: Validate op_read item inputs
  ansible.builtin.assert:
    that:
      - item.vault_name is string
      - item.item_name is string
      - item.field_name is string
    fail_msg: |-
      Each op_read item must define vault_name, item_name, and field_name.

      Example expected structure:

        op_read_items:
          - vault_name: "MyVault"
            item_name: "MyItem"
            field_name: "password"
            out_file: false
            out_file_path: ""
            out_file_ssh_format: false
          - vault_name: "MyVault"
            item_name: "MySSHKeyItem"
            field_name: "privateKey"
            out_file: true
            out_file_path: "/my/ssh/key/path"
            out_file_ssh_format: true
  loop: "{{ op_read_items }}"
  loop_control:
    label: >-
      {{ item.vault_name }}/{{ item.item_name }}/{{ item.field_name | default('') }}

- name: Validate out_file_path when out_file is true
  ansible.builtin.assert:
    that:
      - not (item.out_file | default(false)) or (item.out_file_path is defined and item.out_file_path | length > 0)
    fail_msg: out_file_path must be provided when out_file is true for an op_read item.
  loop: "{{ op_read_items }}"
  loop_control:
    label: >-
      {{ item.vault_name }}/{{ item.item_name }}/{{ item.field_name | default('') }}

- name: Read items from 1Password using op CLI
  ansible.builtin.command:
    argv: >-
      {{
        ['op', 'read','-f']
        + (['--out-file', item.out_file_path] if item.out_file | default(false) else [])
        + [
            'op://'
            ~ item.vault_name
            ~ '/'
            ~ item.item_name
            ~ '/'
            ~ item.field_name
            ~ ('?ssh-format=openssh' if item.out_file_ssh_format | default(false) else '')
          ]
      }}
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ op_read_op_service_account_token }}"
  register: op_read_command_results
  loop: "{{ op_read_items }}"
  loop_control:
    label: >-
      op://{{ item.vault_name }}/{{ item.item_name }}/{{ item.field_name }}{{ '?ssh-format=openssh' if item.out_file_ssh_format | default(false) else '' }}
  changed_when: item.out_file | default(false)

- name: Initialize op_read_result_items
  ansible.builtin.set_fact:
    op_read_result_items: []

- name: Build op_read_result_items
  ansible.builtin.set_fact:
    op_read_result_items: >-
      {{ op_read_result_items
         + [ {
               'vault_name': item.0.vault_name,
               'item_name': item.0.item_name,
               'field_name': item.0.field_name,
               'reference': 'op://' ~ item.0.vault_name ~ '/' ~ item.0.item_name ~ '/' ~ item.0.field_name ~ ( '?ssh-format=openssh' if item.0.out_file_ssh_format | default(false) else '' ),
               'out_file': item.0.out_file | default(false),
               'out_file_path': item.0.out_file_path | default(omit),
               'out_file_ssh_format': item.0.out_file_ssh_format | default(false),
               'value': (item.1.stdout if not (item.0.out_file | default(false)) else omit)
             } ] }}
  loop: "{{ op_read_items | zip(op_read_command_results.results) | list }}"
  loop_control:
    label: >-
      {{ item.0.vault_name }}/{{ item.0.item_name }}/{{ item.0.field_name }}

- name: Pass role artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    role_artifacts_path: "{{ op_read_artifacts_path }}"
    calling_role_name: op_read
    calling_role_artifacts_inputs:
      items: "{{ op_read_result_items }}"
