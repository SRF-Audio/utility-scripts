---
- name: Assert OS is Debian-family on {{ inventory_hostname }}
  ansible.builtin.assert:
    that:
      - ansible_facts.os_family == "Debian"
    fail_msg: >-
      proxmox_tailscale_setup requires a Debian-family OS. Detected: {{ ansible_facts.os_family | default('unknown') }}

- name: >-
    Assert proxmox_tailscale_setup_auth_key is defined on {{ inventory_hostname }}
  ansible.builtin.assert:
    that:
      - proxmox_tailscale_setup_auth_key is defined
      - proxmox_tailscale_setup_auth_key | length > 0
    fail_msg: "proxmox_tailscale_setup_auth_key must be defined and non-empty"
  no_log: true

- name: Install Tailscale via tailscale_install role on {{ inventory_hostname }}
  ansible.builtin.include_role:
    name: tailscale_install
  vars:
    # noqa: var-naming
    artifacts_path: "{{ proxmox_tailscale_setup_artifacts_path }}"

- name: Verify tailscaled binary exists on {{ inventory_hostname }}
  ansible.builtin.command:
    cmd: which tailscaled
  register: proxmox_tailscale_setup_tailscaled_check
  changed_when: false
  failed_when: proxmox_tailscale_setup_tailscaled_check.rc != 0

- name: >-
    Ensure tailscaled service is enabled and started on {{ inventory_hostname }}
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
  register: proxmox_tailscale_setup_service_result

- name: Check tailscale status on {{ inventory_hostname }}
  ansible.builtin.command:
    cmd: tailscale status --json
  register: proxmox_tailscale_setup_status_check
  changed_when: false
  failed_when: false

- name: Parse tailscale status on {{ inventory_hostname }}
  ansible.builtin.set_fact:
    proxmox_tailscale_setup_status: >-
      {{ proxmox_tailscale_setup_status_check.stdout | from_json }}
  when: proxmox_tailscale_setup_status_check.rc == 0

- name: Build tailscale up command flags on {{ inventory_hostname }}
  ansible.builtin.set_fact:
    proxmox_tailscale_setup_hostname: >-
      {{ inventory_hostname }}{{ proxmox_tailscale_setup_hostname_suffix }}
    proxmox_tailscale_setup_tags_flag: >-
      {{ ('--advertise-tags=' ~ (proxmox_tailscale_setup_advertise_tags | join(',')))
         if proxmox_tailscale_setup_advertise_tags | length > 0 else '' }}
    proxmox_tailscale_setup_ssh_flag: >-
      {{ '--ssh' if proxmox_tailscale_setup_ssh_enabled else '' }}
    proxmox_tailscale_setup_operator_flag: >-
      {{ '--operator=' ~ proxmox_tailscale_setup_operator if proxmox_tailscale_setup_operator else '' }}

- name: Determine if tailscale up is needed on {{ inventory_hostname }}
  ansible.builtin.set_fact:
    proxmox_tailscale_setup_needs_up: >-
      {{
        proxmox_tailscale_setup_status_check.rc != 0 or
        (proxmox_tailscale_setup_status.BackendState | default('')) != 'Running' or
        (proxmox_tailscale_setup_status.Self.HostName | default('')) != proxmox_tailscale_setup_hostname
      }}

- name: Run tailscale up on {{ inventory_hostname }}
  ansible.builtin.command:
    cmd: >-
      tailscale up
      --authkey={{ proxmox_tailscale_setup_auth_key }}
      --hostname={{ proxmox_tailscale_setup_hostname }}
      --force-reauth=false
      {{ proxmox_tailscale_setup_ssh_flag }}
      {{ proxmox_tailscale_setup_operator_flag }}
      {{ proxmox_tailscale_setup_tags_flag }}
      {{ proxmox_tailscale_setup_extra_flags | join(' ') }}
  when: proxmox_tailscale_setup_needs_up
  register: proxmox_tailscale_setup_up_result
  changed_when: proxmox_tailscale_setup_up_result.rc == 0
  no_log: true

- name: Get final tailscale status on {{ inventory_hostname }}
  ansible.builtin.command:
    cmd: tailscale status --json
  register: proxmox_tailscale_setup_final_status
  changed_when: false

- name: Parse final tailscale status on {{ inventory_hostname }}
  ansible.builtin.set_fact:
    proxmox_tailscale_setup_final: >-
      {{ proxmox_tailscale_setup_final_status.stdout | from_json }}

- name: Get tailscale IP addresses on {{ inventory_hostname }}
  ansible.builtin.set_fact:
    proxmox_tailscale_setup_ip_v4: >-
      {{ proxmox_tailscale_setup_final.Self.TailscaleIPs | select('match', '^[0-9]+\\.') | first | default('') }}
    proxmox_tailscale_setup_ip_v6: >-
      {{ proxmox_tailscale_setup_final.Self.TailscaleIPs | select('match', '^[a-fA-F0-9]+:') | first | default('') }}

- name: Build proxmox_tailscale_setup_artifacts on {{ inventory_hostname }}
  ansible.builtin.set_fact:
    proxmox_tailscale_setup_artifacts:
      host: "{{ inventory_hostname }}"
      hostname: >-
        {{ proxmox_tailscale_setup_final.Self.HostName | default('') }}
      backend_state: >-
        {{ proxmox_tailscale_setup_final.BackendState | default('') }}
      tailscale_ip_v4: "{{ proxmox_tailscale_setup_ip_v4 }}"
      tailscale_ip_v6: "{{ proxmox_tailscale_setup_ip_v6 }}"
      tags: "{{ proxmox_tailscale_setup_final.Self.Tags | default([]) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"

- name: Record proxmox_tailscale_setup artifacts on {{ inventory_hostname }}
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    role_artifacts_path: "{{ proxmox_tailscale_setup_artifacts_path }}"
    # noqa: var-naming
    calling_role_name: proxmox_tailscale_setup
    calling_role_artifacts_inputs: "{{ proxmox_tailscale_setup_artifacts }}"
