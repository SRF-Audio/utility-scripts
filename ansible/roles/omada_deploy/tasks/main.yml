---
- name: Ensure Omada Argo CD Application is present
  kubernetes.core.k8s:
    state: present
    definition: >-
      {{ lookup('ansible.builtin.template', 'omada-application.yml.j2') }}
    kubeconfig: "{{ omada_deploy_kubeconfig | default(omit, true) }}"
    context: "{{ omada_deploy_context | default(omit, true) }}"
  when: omada_deploy_apply_application | default(true) | bool
  register: omada_deploy_application_result

- name: Discover Omada ingress templates
  ansible.builtin.find:
    paths: "{{ omada_deploy_ingress_templates_root }}"
    patterns:
      - "*.yml.j2"
      - "*.yaml.j2"
    file_type: file
  register: omada_deploy_ingress_templates
  when:
    - omada_deploy_ingress_templates_root is defined
    - omada_deploy_ingress_templates_root | length > 0

- name: Apply Omada ingress templates
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('ansible.builtin.template', item.path) }}"
    kubeconfig: "{{ omada_deploy_kubeconfig | default(omit, true) }}"
    context: "{{ omada_deploy_context | default(omit, true) }}"
  loop: "{{ omada_deploy_ingress_templates.files | default([]) }}"
  loop_control:
    label: "{{ item.path }}"
  when:
    - omada_deploy_ingress_templates is defined
    - omada_deploy_ingress_templates.files | length > 0

- name: >-
    Register omada_deploy role artifacts when omada_deploy_artifacts_path is defined
  ansible.builtin.import_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: omada_deploy
    calling_role_artifacts_inputs:
      application_name: "{{ omada_deploy_application_name }}"
      application_namespace: "{{ omada_deploy_argo_namespace }}"
      omada_deploy_namespace: "{{ omada_deploy_namespace }}"
      ingress_templates_root: "{{ omada_deploy_ingress_templates_root }}"
  when:
    - omada_deploy_artifacts_path is defined
    - omada_deploy_artifacts_path | length > 0
