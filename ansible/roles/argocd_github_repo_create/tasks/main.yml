---
- name: Assert required argocd_github_repo_create inputs are defined
  ansible.builtin.assert:
    that:
      - argocd_github_repo_create_kubeconfig is defined
      - argocd_github_repo_create_context is defined
      - argocd_github_repo_create_argocd_namespace is defined
      - argocd_github_repo_create_repo_url_ssh is defined
      - argocd_github_repo_create_op_item_path is defined
      - argocd_github_repo_create_op_deploy_key_field is defined
      - argocd_github_repo_create_kubeconfig | string | length > 0
      - argocd_github_repo_create_context | length > 0
      - argocd_github_repo_create_argocd_namespace | length > 0
      - argocd_github_repo_create_repo_url_ssh | length > 0
      - argocd_github_repo_create_op_item_path | length > 0
      - argocd_github_repo_create_op_deploy_key_field | length > 0
    fail_msg: |
      All required vars must be defined and non-empty for
      argocd_github_repo_create:
      argocd_github_repo_create_kubeconfig: >-
        {{ argocd_github_repo_create_kubeconfig | default('UNDEFINED') }}
      argocd_github_repo_create_context: >-
        {{ argocd_github_repo_create_context | default('UNDEFINED') }}
      argocd_github_repo_create_argocd_namespace: >-
        {{ argocd_github_repo_create_argocd_namespace |
           default('UNDEFINED') }}
      argocd_github_repo_create_repo_url_ssh: >-
        {{ argocd_github_repo_create_repo_url_ssh |
           default('UNDEFINED') }}
      argocd_github_repo_create_op_item_path: >-
        {{ argocd_github_repo_create_op_item_path |
           default('UNDEFINED') }}
      argocd_github_repo_create_op_deploy_key_field: >-
        {{ argocd_github_repo_create_op_deploy_key_field |
           default('UNDEFINED') }}

- name: Check if OnePasswordItem CRD exists
  kubernetes.core.k8s_info:
    kubeconfig: "{{ argocd_github_repo_create_kubeconfig }}"
    context: "{{ argocd_github_repo_create_context }}"
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: onepassworditems.onepassword.com
  register: argocd_github_repo_create_crd_check
  failed_when: >-
    argocd_github_repo_create_crd_check.resources is not defined or
    argocd_github_repo_create_crd_check.resources | length == 0

- name: Verify Argo CD namespace exists
  kubernetes.core.k8s_info:
    kubeconfig: "{{ argocd_github_repo_create_kubeconfig }}"
    context: "{{ argocd_github_repo_create_context }}"
    api_version: v1
    kind: Namespace
    name: "{{ argocd_github_repo_create_argocd_namespace }}"
  register: argocd_github_repo_create_namespace_check
  failed_when: >-
    argocd_github_repo_create_namespace_check.resources is not defined or
    argocd_github_repo_create_namespace_check.resources | length == 0

- name: Create temporary directory for manifests
  ansible.builtin.tempfile:
    state: directory
    suffix: -argocd-github-repo-create
  register: argocd_github_repo_create_temp_dir

- name: Render OnePasswordItem manifest to temporary location
  ansible.builtin.template:
    src: "{{ role_path }}/templates/onepassword-item.yml.j2"
    dest: "{{ argocd_github_repo_create_temp_dir.path }}/onepassword-item.yml"
    mode: "0644"

- name: Apply OnePasswordItem to Argo CD namespace
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: "{{ argocd_github_repo_create_kubeconfig }}"
    k8s_object_manager_context: "{{ argocd_github_repo_create_context }}"
    k8s_object_manager_state: present
    k8s_object_manager_src: >-
      {{ argocd_github_repo_create_temp_dir.path }}/onepassword-item.yml

- name: Wait for 1Password Operator to create secret
  kubernetes.core.k8s_info:
    kubeconfig: "{{ argocd_github_repo_create_kubeconfig }}"
    context: "{{ argocd_github_repo_create_context }}"
    api_version: v1
    kind: Secret
    namespace: "{{ argocd_github_repo_create_argocd_namespace }}"
    name: "{{ argocd_github_repo_create_op_item_name }}"
  register: argocd_github_repo_create_op_secret
  until:
    - argocd_github_repo_create_op_secret.resources is defined
    - argocd_github_repo_create_op_secret.resources | length > 0
    - argocd_github_repo_create_op_secret.resources[0].data is defined
    - >-
      (argocd_github_repo_create_op_secret.resources[0].data[
        argocd_github_repo_create_op_secret_data_key
      ] | default('')) | length > 0
  retries: 30
  delay: 5
  failed_when: >-
    argocd_github_repo_create_op_secret.resources is not defined or
    argocd_github_repo_create_op_secret.resources | length == 0 or
    argocd_github_repo_create_op_secret.resources[0].data is not defined or
    (argocd_github_repo_create_op_secret.resources[0].data[
      argocd_github_repo_create_op_secret_data_key
    ] | default('')) | length == 0

- name: Extract SSH private key from 1Password secret
  ansible.builtin.set_fact:
    argocd_github_repo_create_ssh_private_key: >-
      {{ argocd_github_repo_create_op_secret.resources[0].data[
           argocd_github_repo_create_op_secret_data_key
         ] | b64decode }}
  no_log: true

- name: Validate SSH private key is not empty
  ansible.builtin.assert:
    that:
      - argocd_github_repo_create_ssh_private_key is defined
      - argocd_github_repo_create_ssh_private_key | length > 0
      - argocd_github_repo_create_ssh_private_key is string
    fail_msg: >-
      SSH private key extracted from 1Password secret is empty or invalid

- name: Assert expected SSH key field exists in 1Password-generated secret
  ansible.builtin.assert:
    that:
      - >-
        (argocd_github_repo_create_op_secret.resources[0].data[
          argocd_github_repo_create_op_secret_data_key
        ] | default('')) | length > 0
    fail_msg: >-
      Expected secret data key "{{ argocd_github_repo_create_op_secret_data_key }}"
      not found. Available keys: {{
        (argocd_github_repo_create_op_secret.resources[0].data | default({})).keys() | list
      }}

- name: >-
    Render Argo CD repository secret manifest to temporary location
  ansible.builtin.template:
    src: >-
      {{ role_path }}/templates/argocd-repository-secret.yml.j2
    dest: >-
      {{ argocd_github_repo_create_temp_dir.path }}/argocd-repository-secret.yml
    mode: "0600"
  no_log: true

- name: Apply Argo CD repository secret
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: >-
      {{ argocd_github_repo_create_kubeconfig }}
    k8s_object_manager_context: >-
      {{ argocd_github_repo_create_context }}
    k8s_object_manager_state: present
    k8s_object_manager_src: >-
      {{ argocd_github_repo_create_temp_dir.path }}/argocd-repository-secret.yml
  no_log: true

- name: Clean up temporary directory
  ansible.builtin.file:
    path: "{{ argocd_github_repo_create_temp_dir.path }}"
    state: absent

- name: Persist argocd_github_repo_create artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: "argocd_github_repo_create"
    calling_role_artifacts_inputs:
      k3s_cluster_name: >-
        {{ k3s_cluster_name | default('', true) }}
      argocd_namespace: "{{ argocd_github_repo_create_argocd_namespace }}"
      repo_url: "{{ argocd_github_repo_create_repo_url_ssh }}"
      op_item_name: "{{ argocd_github_repo_create_op_item_name }}"
      repo_secret_name: "{{ argocd_github_repo_create_repo_secret_name }}"
