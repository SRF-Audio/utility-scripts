---
- name: Assert required inputs are defined
  ansible.builtin.assert:
    that:
      - deploy_nfs_provisioner_kubeconfig is defined
      - deploy_nfs_provisioner_context is defined
      - deploy_nfs_provisioner_kubeconfig | string | length > 0
      - deploy_nfs_provisioner_context | length > 0
    fail_msg: >-
      deploy_nfs_provisioner_kubeconfig and deploy_nfs_provisioner_context
      must be defined and non-empty.

- name: Assert ArgoCD Application manifest exists
  ansible.builtin.stat:
    path: "{{ deploy_nfs_provisioner_argocd_application_path }}"
  register: deploy_nfs_provisioner_argocd_app_stat
  failed_when: not deploy_nfs_provisioner_argocd_app_stat.stat.exists

- name: Assert StorageClass manifests exist
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ deploy_nfs_provisioner_storageclass_paths }}"
  register: deploy_nfs_provisioner_sc_stat
  failed_when: >-
    not deploy_nfs_provisioner_sc_stat.results
    | map(attribute='stat.exists')
    | select('equalto', false)
    | list | length == 0

- name: Apply ArgoCD Application manifest
  kubernetes.core.k8s:
    kubeconfig: "{{ deploy_nfs_provisioner_kubeconfig }}"
    context: "{{ deploy_nfs_provisioner_context }}"
    state: present
    src: "{{ deploy_nfs_provisioner_argocd_application_path }}"

- name: Wait for ArgoCD Application to become Healthy and Synced
  kubernetes.core.k8s_info:
    kubeconfig: "{{ deploy_nfs_provisioner_kubeconfig }}"
    context: "{{ deploy_nfs_provisioner_context }}"
    kind: Application
    api_version: argoproj.io/v1alpha1
    namespace: "{{ deploy_nfs_provisioner_argocd_namespace }}"
    name: "{{ deploy_nfs_provisioner_argocd_app_name }}"
  register: deploy_nfs_provisioner_app_info
  until:
    - deploy_nfs_provisioner_app_info.resources is defined
    - deploy_nfs_provisioner_app_info.resources | length > 0
    - deploy_nfs_provisioner_app_info.resources[0].status is defined
    - deploy_nfs_provisioner_app_info.resources[0].status.sync is defined
    - >-
      deploy_nfs_provisioner_app_info.resources[0].status.sync.status
      is defined
    - >-
      deploy_nfs_provisioner_app_info.resources[0].status.sync.status
      == "Synced"
    - deploy_nfs_provisioner_app_info.resources[0].status.health is defined
    - >-
      deploy_nfs_provisioner_app_info.resources[0].status.health.status
      is defined
    - >-
      deploy_nfs_provisioner_app_info.resources[0].status.health.status
      == "Healthy"
  retries: "{{ deploy_nfs_provisioner_wait_retries }}"
  delay: "{{ deploy_nfs_provisioner_wait_delay }}"

- name: Apply StorageClass manifests
  kubernetes.core.k8s:
    kubeconfig: "{{ deploy_nfs_provisioner_kubeconfig }}"
    context: "{{ deploy_nfs_provisioner_context }}"
    state: present
    src: "{{ item }}"
  loop: "{{ deploy_nfs_provisioner_storageclass_paths }}"

- name: Validate StorageClasses exist
  kubernetes.core.k8s_info:
    kubeconfig: "{{ deploy_nfs_provisioner_kubeconfig }}"
    context: "{{ deploy_nfs_provisioner_context }}"
    kind: StorageClass
    api_version: storage.k8s.io/v1
    name: "{{ item }}"
  loop:
    - nfs-synology-delete
    - nfs-synology-retain
    - nfs-static-retain
  register: deploy_nfs_provisioner_sc_info
  failed_when: >-
    deploy_nfs_provisioner_sc_info.resources is not defined
    or deploy_nfs_provisioner_sc_info.resources | length == 0

- name: Set deploy_nfs_provisioner artifacts
  ansible.builtin.set_fact:
    deploy_nfs_provisioner_artifacts:
      kubeconfig: "{{ deploy_nfs_provisioner_kubeconfig }}"
      context: "{{ deploy_nfs_provisioner_context }}"
      argocd_application_name: "{{ deploy_nfs_provisioner_argocd_app_name }}"
      argocd_namespace: "{{ deploy_nfs_provisioner_argocd_namespace }}"
      storageclasses:
        - nfs-synology-delete
        - nfs-synology-retain
        - nfs-static-retain

- name: Persist deploy_nfs_provisioner artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: deploy_nfs_provisioner
    calling_role_artifacts_inputs: "{{ deploy_nfs_provisioner_artifacts }}"
