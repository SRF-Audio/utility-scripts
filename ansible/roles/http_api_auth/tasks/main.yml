---
# roles/http_api_auth/tasks/main.yml
- name: Assert required HTTP API auth inputs are defined
  ansible.builtin.assert:
    that:
      - http_api_name is defined
      - http_api_base_url is defined
      - http_api_auth_path is defined
      - http_api_name | length > 0
      - http_api_base_url | length > 0
      - http_api_auth_path | length > 0
    fail_msg: "http_api_name, http_api_base_url, and http_api_auth_path must be defined for http_api_auth."

- name: Build HTTP API auth URL
  ansible.builtin.set_fact:
    http_api_auth_url: >-
      {{ http_api_base_url.rstrip('/') }}{{ http_api_auth_path }}

- name: Perform HTTP API auth request
  ansible.builtin.uri:
    url: "{{ http_api_auth_url }}"
    method: "{{ http_api_method }}"
    validate_certs: "{{ http_api_validate_certs }}"
    headers: "{{ http_api_headers if http_api_headers | length > 0 else omit }}"
    body_format: "{{ 'json' if http_api_body | length > 0 else omit }}"
    body: "{{ http_api_body if http_api_body | length > 0 else omit }}"
    status_code: "{{ http_api_status_code }}"
    return_content: true
  register: http_api_auth_response

- name: Set dynamic HTTP API auth result fact
  ansible.builtin.set_fact: >-
    "{{ (http_api_register_prefix | length > 0)
        | ternary(
          http_api_register_prefix,
          http_api_name | regex_replace('[^A-Za-z0-9_]', '_')
        )
        ~ '_auth_result' }}": "{{ http_api_auth_response }}"
