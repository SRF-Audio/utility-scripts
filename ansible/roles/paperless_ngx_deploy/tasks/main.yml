- name: Assert required paperless_ngx_deploy inputs are defined
  ansible.builtin.assert:
    that:
      - paperless_ngx_deploy_kubeconfig is defined
      - paperless_ngx_deploy_context is defined
      - paperless_ngx_deploy_kubeconfig | string | length > 0
      - paperless_ngx_deploy_context | length > 0
    fail_msg: "paperless_ngx_deploy_kubeconfig and paperless_ngx_deploy_context must be defined for paperless_ngx_deploy."

- name: Render paperless_ngx_deploy ArgoCD Application manifest
  ansible.builtin.template:
    src: "{{ role_path }}/templates/application.yml.j2"
    dest: "{{ role_path }}/templates/application.yml"
    mode: "0644"

- name: Set static path to pass to k8s_object_manager role
  ansible.builtin.set_fact:
    paperless_ngx_deploy_manifest: "{{ role_path }}/templates/application.yml"

- name: Apply paperless-ngx ArgoCD Application manifest
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: "{{ paperless_ngx_deploy_kubeconfig }}"
    k8s_object_manager_context: "{{ paperless_ngx_deploy_context }}"
    k8s_object_manager_state: present
    k8s_object_manager_src: "{{ paperless_ngx_deploy_manifest }}"
  when: paperless_ngx_deploy_apply_objects | bool

- name: Capture k8s_object_manager result if k8s objects were applied
  ansible.builtin.set_fact:
    paperless_ngx_deploy_k8s_result: "{{ k8s_object_manager_result }}"
  when: paperless_ngx_deploy_apply_objects | bool

- name: Set empty k8s result if objects were not applied
  ansible.builtin.set_fact:
    paperless_ngx_deploy_k8s_result: {}
  when: not (paperless_ngx_deploy_apply_objects | bool)

- name: Wait for Paperless-NGX ArgoCD Application to be synced and healthy
  kubernetes.core.k8s_info:
    kubeconfig: "{{ paperless_ngx_deploy_kubeconfig }}"
    context: "{{ paperless_ngx_deploy_context }}"
    api_version: argoproj.io/v1alpha1
    kind: Application
    namespace: "{{ paperless_ngx_deploy_argocd_namespace }}"
    name: "{{ paperless_ngx_deploy_app_name }}"
  register: paperless_ngx_app_status
  until:
    - paperless_ngx_app_status.resources is defined
    - paperless_ngx_app_status.resources | length > 0
    - paperless_ngx_app_status.resources[0].status is defined
    - paperless_ngx_app_status.resources[0].status.sync is defined
    - paperless_ngx_app_status.resources[0].status.sync.status == "Synced"
    - paperless_ngx_app_status.resources[0].status.health is defined
    - paperless_ngx_app_status.resources[0].status.health.status == "Healthy"
  retries: 60
  delay: 5
  when: paperless_ngx_deploy_apply_objects | bool

- name: Persist paperless_ngx_deploy artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: "paperless_ngx_deploy"
    calling_role_artifacts_inputs:
      k3s_cluster_name: "{{ paperless_ngx_deploy_cluster_name | default(k3s_cluster_name | default('', true), true) }}"
      application_name: "{{ paperless_ngx_deploy_app_name }}"
      argocd_namespace: "{{ paperless_ngx_deploy_argocd_namespace }}"
      application_result: "{{ paperless_ngx_deploy_k8s_result }}"
