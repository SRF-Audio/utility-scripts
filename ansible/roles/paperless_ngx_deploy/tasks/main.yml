---
- name: Assert required paperless_ngx_deploy inputs are defined
  ansible.builtin.assert:
    that:
      - paperless_ngx_deploy_kubeconfig is defined
      - paperless_ngx_deploy_context is defined
      - paperless_ngx_deploy_kubeconfig | string | length > 0
      - paperless_ngx_deploy_context | length > 0
    fail_msg: >-
      paperless_ngx_deploy_kubeconfig and paperless_ngx_deploy_context
      must be defined for paperless_ngx_deploy.

- name: Render paperless_ngx_deploy secrets ArgoCD Application manifest
  ansible.builtin.template:
    src: "{{ role_path }}/templates/secrets_application.yml.j2"
    dest: >-
      {{
        [
          role_path,
          'templates',
          'secrets_application.yml'
        ] | join('/')
      }}
    mode: "0644"

- name: Render paperless_ngx_deploy main ArgoCD Application manifest
  ansible.builtin.template:
    src: "{{ role_path }}/templates/application.yml.j2"
    dest: >-
      {{
        [
          role_path,
          'templates',
          'application.yml'
        ] | join('/')
      }}
    mode: "0644"

- name: Set paths for both Application manifests
  ansible.builtin.set_fact:
    paperless_ngx_deploy_secrets_manifest: >-
      {{ [role_path, 'templates', 'secrets_application.yml'] | join('/') }}
    paperless_ngx_deploy_main_manifest: >-
      {{ [role_path, 'templates', 'application.yml'] | join('/') }}

- name: Apply paperless-ngx secrets ArgoCD Application manifest
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: "{{ paperless_ngx_deploy_kubeconfig }}"
    k8s_object_manager_context: "{{ paperless_ngx_deploy_context }}"
    k8s_object_manager_state: present
    k8s_object_manager_src: "{{ paperless_ngx_deploy_secrets_manifest }}"
  when: paperless_ngx_deploy_apply_objects | bool

- name: Capture secrets k8s_object_manager result
  ansible.builtin.set_fact:
    paperless_ngx_deploy_secrets_k8s_result: >-
      {{ k8s_object_manager_result }}
  when: paperless_ngx_deploy_apply_objects | bool

- name: Apply paperless-ngx main ArgoCD Application manifest
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: "{{ paperless_ngx_deploy_kubeconfig }}"
    k8s_object_manager_context: "{{ paperless_ngx_deploy_context }}"
    k8s_object_manager_state: present
    k8s_object_manager_src: "{{ paperless_ngx_deploy_main_manifest }}"
  when: paperless_ngx_deploy_apply_objects | bool

- name: Capture main k8s_object_manager result
  ansible.builtin.set_fact:
    paperless_ngx_deploy_main_k8s_result: "{{ k8s_object_manager_result }}"
  when: paperless_ngx_deploy_apply_objects | bool

- name: Set empty k8s results if objects were not applied
  ansible.builtin.set_fact:
    paperless_ngx_deploy_secrets_k8s_result: {}
    paperless_ngx_deploy_main_k8s_result: {}
  when: not (paperless_ngx_deploy_apply_objects | bool)

- name: Wait for secrets ArgoCD Application to be synced and healthy
  kubernetes.core.k8s_info:
    kubeconfig: "{{ paperless_ngx_deploy_kubeconfig }}"
    context: "{{ paperless_ngx_deploy_context }}"
    api_version: argoproj.io/v1alpha1
    kind: Application
    namespace: "{{ paperless_ngx_deploy_argocd_namespace }}"
    name: "{{ paperless_ngx_deploy_secrets_app_name }}"
  register: paperless_ngx_secrets_app_status
  until:
    - paperless_ngx_secrets_app_status.resources is defined
    - paperless_ngx_secrets_app_status.resources | length > 0
    - paperless_ngx_secrets_app_status.resources[0].status is defined
    - paperless_ngx_secrets_app_status.resources[0].status.sync is defined
    - >-
      paperless_ngx_secrets_app_status.resources[0].status.sync.status ==
      "Synced"
    - >-
      paperless_ngx_secrets_app_status.resources[0].status.health is defined
    - >-
      paperless_ngx_secrets_app_status.resources[0].status.health.status ==
      "Healthy"
  retries: 60
  delay: 5
  when: paperless_ngx_deploy_apply_objects | bool

- name: Wait for main ArgoCD Application to be synced and healthy
  kubernetes.core.k8s_info:
    kubeconfig: "{{ paperless_ngx_deploy_kubeconfig }}"
    context: "{{ paperless_ngx_deploy_context }}"
    api_version: argoproj.io/v1alpha1
    kind: Application
    namespace: "{{ paperless_ngx_deploy_argocd_namespace }}"
    name: "{{ paperless_ngx_deploy_app_name }}"
  register: paperless_ngx_app_status
  until:
    - paperless_ngx_app_status.resources is defined
    - paperless_ngx_app_status.resources | length > 0
    - paperless_ngx_app_status.resources[0].status is defined
    - paperless_ngx_app_status.resources[0].status.sync is defined
    - >-
      paperless_ngx_app_status.resources[0].status.sync.status == "Synced"
    - paperless_ngx_app_status.resources[0].status.health is defined
    - >-
      paperless_ngx_app_status.resources[0].status.health.status == "Healthy"
  retries: 60
  delay: 5
  when: paperless_ngx_deploy_apply_objects | bool

- name: Persist paperless_ngx_deploy artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: "paperless_ngx_deploy"
    calling_role_artifacts_inputs:
      k3s_cluster_name: >-
        {{ paperless_ngx_deploy_cluster_name |
        default(k3s_cluster_name | default('', true), true) }}
      secrets_application_name: >-
        {{ paperless_ngx_deploy_secrets_app_name }}
      main_application_name: "{{ paperless_ngx_deploy_app_name }}"
      argocd_namespace: "{{ paperless_ngx_deploy_argocd_namespace }}"
      secrets_application_result: >-
        {{ paperless_ngx_deploy_secrets_k8s_result }}
      main_application_result: "{{ paperless_ngx_deploy_main_k8s_result }}"
