---
- name: Assert required paperless_ngx_deploy inputs are defined
  ansible.builtin.assert:
    that:
      - paperless_ngx_deploy_kubeconfig is defined
      - paperless_ngx_deploy_context is defined
      - paperless_ngx_deploy_manifest_src is defined
      - paperless_ngx_deploy_kubeconfig | string | length > 0
      - paperless_ngx_deploy_context | length > 0
      - paperless_ngx_deploy_manifest_src | length > 0
    fail_msg: >-
      paperless_ngx_deploy_kubeconfig, paperless_ngx_deploy_context,
      and paperless_ngx_deploy_manifest_src must be defined for
      paperless_ngx_deploy.

- name: Apply paperless-ngx ArgoCD Application manifest
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: "{{ paperless_ngx_deploy_kubeconfig }}"
    k8s_object_manager_context: "{{ paperless_ngx_deploy_context }}"
    k8s_object_manager_state: present
    k8s_object_manager_src: "{{ paperless_ngx_deploy_manifest_src }}"
  when: paperless_ngx_deploy_apply_objects | bool

- name: Capture k8s_object_manager result
  ansible.builtin.set_fact:
    paperless_ngx_deploy_k8s_result: "{{ k8s_object_manager_result }}"
  when: paperless_ngx_deploy_apply_objects | bool

- name: Set empty k8s result if objects were not applied
  ansible.builtin.set_fact:
    paperless_ngx_deploy_k8s_result: {}
  when: not (paperless_ngx_deploy_apply_objects | bool)

- name: Persist paperless_ngx_deploy artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: paperless_ngx_deploy
    calling_role_artifacts_inputs:
      k3s_cluster_name: >-
        {{ paperless_ngx_deploy_cluster_name |
        default(k3s_cluster_name | default('', true), true) }}
      manifest_src: "{{ paperless_ngx_deploy_manifest_src }}"
      apply_objects: "{{ paperless_ngx_deploy_apply_objects }}"
      application_apply_result: "{{ paperless_ngx_deploy_k8s_result }}"
