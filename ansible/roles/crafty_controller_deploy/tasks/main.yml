---
- name: Assert required crafty_controller_deploy inputs are defined
  ansible.builtin.assert:
    that:
      - crafty_controller_deploy_kubeconfig is defined
      - crafty_controller_deploy_context is defined
      - crafty_controller_deploy_kubeconfig | string | length > 0
      - crafty_controller_deploy_context | length > 0
    fail_msg: >
      crafty_controller_deploy_kubeconfig and
      crafty_controller_deploy_context must be defined for
      crafty_controller_deploy.

- name: Render crafty_controller_deploy ArgoCD Application manifest
  ansible.builtin.template:
    src: "{{ role_path }}/templates/application.yml.j2"
    dest: "{{ role_path }}/templates/application.yml"
    mode: "0644"

- name: Set static path to pass to k8s_object_manager role
  ansible.builtin.set_fact:
    crafty_controller_deploy_manifest: >-
      {{ role_path }}/templates/application.yml

- name: Apply Crafty Controller ArgoCD Application manifest
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: >-
      {{ crafty_controller_deploy_kubeconfig }}
    k8s_object_manager_context: "{{ crafty_controller_deploy_context }}"
    k8s_object_manager_state: present
    k8s_object_manager_src: "{{ crafty_controller_deploy_manifest }}"
  when: crafty_controller_deploy_apply_objects | bool

- name: Capture k8s_object_manager result if k8s objects were applied
  ansible.builtin.set_fact:
    crafty_controller_deploy_k8s_result: >-
      {{ k8s_object_manager_result }}
  when: crafty_controller_deploy_apply_objects | bool

- name: Set empty k8s result if objects were not applied
  ansible.builtin.set_fact:
    crafty_controller_deploy_k8s_result: {}
  when: not (crafty_controller_deploy_apply_objects | bool)

- name: Wait for Crafty Controller ArgoCD Application to be Synced and not Degraded
  kubernetes.core.k8s_info:
    kubeconfig: "{{ crafty_controller_deploy_kubeconfig }}"
    context: "{{ crafty_controller_deploy_context }}"
    api_version: argoproj.io/v1alpha1
    kind: Application
    namespace: "{{ crafty_controller_deploy_argocd_namespace }}"
    name: "{{ crafty_controller_deploy_app_name }}"
  register: crafty_controller_app_status
  until:
    - (crafty_controller_app_status.resources | default([])) | length > 0
    - >-
      (crafty_controller_app_status.resources[0].status.sync.status | default('')) ==
      'Synced'
    - >-
      (crafty_controller_app_status.resources[0].status.health.status | default('')) !=
      'Degraded'
  retries: 60
  delay: 5
  when: crafty_controller_deploy_apply_objects | bool

- name: Persist crafty_controller_deploy artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: "crafty_controller_deploy"
    calling_role_artifacts_inputs:
      k3s_cluster_name: >-
        {{
          crafty_controller_deploy_cluster_name |
          default(k3s_cluster_name | default('', true), true)
        }}
      app_name: "{{ crafty_controller_deploy_app_name }}"
      namespace: "{{ crafty_controller_deploy_namespace }}"
      argocd_namespace: "{{ crafty_controller_deploy_argocd_namespace }}"
      repo_url: "{{ crafty_controller_deploy_repo_url }}"
      target_revision: "{{ crafty_controller_deploy_target_revision }}"
      path: "{{ crafty_controller_deploy_path }}"
      application_result: "{{ crafty_controller_deploy_k8s_result }}"
