- name: Assert proxmox_vm_disk_manager required inputs are defined
  ansible.builtin.assert:
    that:
      - proxmox_vm_disk_manager_api_host is defined
      - proxmox_vm_disk_manager_api_host | length > 0
      - proxmox_vm_disk_manager_api_user is defined
      - proxmox_vm_disk_manager_api_user | length > 0
      - proxmox_vm_disk_manager_node is defined
      - proxmox_vm_disk_manager_node | length > 0
      - proxmox_vm_disk_manager_vmid is defined
      - proxmox_vm_disk_manager_disk is defined
      - proxmox_vm_disk_manager_disk | length > 0
      - proxmox_vm_disk_manager_state is defined
      - proxmox_vm_disk_manager_state | length > 0
      - (proxmox_vm_disk_manager_api_password is defined and proxmox_vm_disk_manager_api_password | length > 0) or
        (proxmox_vm_disk_manager_api_token_id is defined and proxmox_vm_disk_manager_api_token_id | length > 0 and
        proxmox_vm_disk_manager_api_token_secret is defined and proxmox_vm_disk_manager_api_token_secret | length > 0)
    fail_msg: Required proxmox_vm_disk_manager variables must be defined. Either api_password or api_token_id and api_token_secret must be provided.
  no_log: true

- name: Build proxmox_vm_disk_manager effective parameters
  ansible.builtin.set_fact:
    proxmox_vm_disk_manager_effective_params: >-
      {{
        proxmox_vm_disk_manager_module_params | default({}, true)
        | combine({
            'api_host': proxmox_vm_disk_manager_api_host,
            'api_user': proxmox_vm_disk_manager_api_user,
            'node': proxmox_vm_disk_manager_node,
            'vmid': proxmox_vm_disk_manager_vmid,
            'disk': proxmox_vm_disk_manager_disk,
            'state': proxmox_vm_disk_manager_state,
            'validate_certs': proxmox_vm_disk_manager_validate_certs
          }, recursive=False)
        | combine(
            (proxmox_vm_disk_manager_api_password is defined and proxmox_vm_disk_manager_api_password | length > 0)
            | ternary({'api_password': proxmox_vm_disk_manager_api_password}, {}),
            recursive=False
          )
        | combine(
            (proxmox_vm_disk_manager_api_token_id is defined and proxmox_vm_disk_manager_api_token_id | length > 0 and
             proxmox_vm_disk_manager_api_token_secret is defined and proxmox_vm_disk_manager_api_token_secret | length > 0)
            | ternary({
                'api_token_id': proxmox_vm_disk_manager_api_token_id,
                'api_token_secret': proxmox_vm_disk_manager_api_token_secret
              }, {}),
            recursive=False
          )
      }}
  no_log: true

- name: Manage Proxmox VM disk {{ proxmox_vm_disk_manager_disk }}
  community.proxmox.proxmox_disk: "{{ proxmox_vm_disk_manager_effective_params }}"
  register: proxmox_vm_disk_manager_result

- name: Record proxmox_vm_disk_manager artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    calling_role_name: proxmox_vm_disk_manager
    calling_role_artifacts_inputs:
      proxmox_vm_disk_manager_effective_params: "{{ proxmox_vm_disk_manager_effective_params }}"
      proxmox_vm_disk_manager_result: "{{ proxmox_vm_disk_manager_result }}"
