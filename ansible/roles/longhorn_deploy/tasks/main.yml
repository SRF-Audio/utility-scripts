---
- name: Assert required Longhorn deployment inputs are defined
  ansible.builtin.assert:
    that:
      - longhorn_deploy_kubeconfig is defined
      - longhorn_deploy_context is defined
      - longhorn_deploy_kubeconfig | string | length > 0
      - longhorn_deploy_context | length > 0
    fail_msg: "longhorn_deploy_kubeconfig and longhorn_deploy_context must be defined for longhorn_deploy."

- name: Set Longhorn paths
  ansible.builtin.set_fact:
    longhorn_deploy_manifest_src: "{{ role_path }}/files/longhorn.yml"

- name: Apply Longhorn Argo CD Application manifest
  ansible.builtin.include_role:
    name: k8s_object_manager
  vars:
    k8s_object_manager_kubeconfig: "{{ longhorn_deploy_kubeconfig }}"
    k8s_object_manager_context: "{{ longhorn_deploy_context }}"
    k8s_object_manager_state: present
    k8s_object_manager_src: "{{ longhorn_deploy_manifest_src }}"

- name: Persist longhorn_deploy artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: "longhorn_deploy"
    calling_role_artifacts_inputs:
      k3s_cluster_name: "{{ longhorn_deploy_cluster_name | default(k3s_cluster_name | default('', true), true) }}"
      application_name: "longhorn"
      argocd_namespace: "argocd"
      application_result: "{{ k8s_object_manager_result }}"
