---
- name: Assert required inputs are defined
  ansible.builtin.assert:
    that:
      - nfs_provisioner_deploy_kubeconfig is defined
      - nfs_provisioner_deploy_context is defined
      - nfs_provisioner_deploy_kubeconfig | string | length > 0
      - nfs_provisioner_deploy_context | length > 0
    fail_msg: >-
      nfs_provisioner_deploy_kubeconfig and nfs_provisioner_deploy_context
      must be defined and non-empty.

- name: Assert ArgoCD Application manifest exists
  ansible.builtin.stat:
    path: "{{ nfs_provisioner_deploy_argocd_application_path }}"
  register: nfs_provisioner_deploy_argocd_app_stat
  failed_when: not nfs_provisioner_deploy_argocd_app_stat.stat.exists

- name: Check if StorageClass manifests exist
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ nfs_provisioner_deploy_storageclass_paths }}"
  register: nfs_provisioner_deploy_sc_stat

- name: Verify all StorageClass manifests exist
  ansible.builtin.assert:
    that:
      - item.stat.exists
    fail_msg: >-
      StorageClass manifest file does not exist: {{ item.item }}
  loop: "{{ nfs_provisioner_deploy_sc_stat.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Apply ArgoCD Application manifest
  kubernetes.core.k8s:
    kubeconfig: "{{ nfs_provisioner_deploy_kubeconfig }}"
    context: "{{ nfs_provisioner_deploy_context }}"
    state: present
    src: "{{ nfs_provisioner_deploy_argocd_application_path }}"

- name: Wait for ArgoCD Application to become Healthy and Synced
  kubernetes.core.k8s_info:
    kubeconfig: "{{ nfs_provisioner_deploy_kubeconfig }}"
    context: "{{ nfs_provisioner_deploy_context }}"
    kind: Application
    api_version: argoproj.io/v1alpha1
    namespace: "{{ nfs_provisioner_deploy_argocd_namespace }}"
    name: "{{ nfs_provisioner_deploy_argocd_app_name }}"
  register: nfs_provisioner_deploy_app_info
  until:
    - nfs_provisioner_deploy_app_info.resources is defined
    - nfs_provisioner_deploy_app_info.resources | length > 0
    - nfs_provisioner_deploy_app_info.resources[0].status is defined
    - nfs_provisioner_deploy_app_info.resources[0].status.sync is defined
    - >-
      nfs_provisioner_deploy_app_info.resources[0].status.sync.status
      is defined
    - >-
      nfs_provisioner_deploy_app_info.resources[0].status.sync.status
      == "Synced"
    - nfs_provisioner_deploy_app_info.resources[0].status.health is defined
    - >-
      nfs_provisioner_deploy_app_info.resources[0].status.health.status
      is defined
    - >-
      nfs_provisioner_deploy_app_info.resources[0].status.health.status
      == "Healthy"
  retries: "{{ nfs_provisioner_deploy_wait_retries }}"
  delay: "{{ nfs_provisioner_deploy_wait_delay }}"

- name: Apply StorageClass manifests
  kubernetes.core.k8s:
    kubeconfig: "{{ nfs_provisioner_deploy_kubeconfig }}"
    context: "{{ nfs_provisioner_deploy_context }}"
    state: present
    src: "{{ item }}"
  loop: "{{ nfs_provisioner_deploy_storageclass_paths }}"

- name: Validate StorageClasses exist
  kubernetes.core.k8s_info:
    kubeconfig: "{{ nfs_provisioner_deploy_kubeconfig }}"
    context: "{{ nfs_provisioner_deploy_context }}"
    kind: StorageClass
    api_version: storage.k8s.io/v1
    name: "{{ item }}"
  loop:
    - nfs-synology-delete
    - nfs-synology-retain
    - nfs-static-retain
  register: nfs_provisioner_deploy_sc_info
  failed_when: >-
    nfs_provisioner_deploy_sc_info.resources is not defined
    or nfs_provisioner_deploy_sc_info.resources | length == 0

- name: Set nfs_provisioner_deploy artifacts
  ansible.builtin.set_fact:
    nfs_provisioner_deploy_artifacts:
      kubeconfig: "{{ nfs_provisioner_deploy_kubeconfig }}"
      context: "{{ nfs_provisioner_deploy_context }}"
      argocd_application_name: "{{ nfs_provisioner_deploy_argocd_app_name }}"
      argocd_namespace: "{{ nfs_provisioner_deploy_argocd_namespace }}"
      storageclasses:
        - nfs-synology-delete
        - nfs-synology-retain
        - nfs-static-retain

- name: Persist nfs_provisioner_deploy artifacts
  ansible.builtin.include_role:
    name: role_artifacts
  vars:
    # noqa: var-naming
    calling_role_name: nfs_provisioner_deploy
    calling_role_artifacts_inputs: "{{ nfs_provisioner_deploy_artifacts }}"
