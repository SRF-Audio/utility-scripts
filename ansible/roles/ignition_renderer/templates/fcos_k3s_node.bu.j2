variant: {{ proxmox_fcos_variant }}
version: {{ proxmox_fcos_version }}

{% set is_control_plane = proxmox_k3s_role in ['bootstrap', 'join'] %}
{% set is_bootstrap = proxmox_k3s_role == 'bootstrap' %}
{% set is_worker = proxmox_k3s_role == 'worker' %}
{% set proxmox_k3s_control_plane_start_ip = proxmox_cluster_layout.control_planes[0].ip %}

passwd:
  users:
    - name: sfroeber
      groups: ["wheel"]
      ssh_authorized_keys:
        - "{{ lookup('community.general.onepassword',
                     'coachlight-homelab SSH key',
                     field='public_key',
                     vault='HomeLab') }}"

storage:
  files:
    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents:
        inline: "{{ proxmox_vm_hostname }}"

{% if is_control_plane %}
    - path: /etc/systemd/resolved.conf.d/nextdns.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [Resolve]
          DNS=45.90.28.0#e3698d.dns.nextdns.io
          DNS=2a07:a8c0::#e3698d.dns.nextdns.io
          DNS=45.90.30.0#e3698d.dns.nextdns.io
          DNS=2a07:a8c1::#e3698d.dns.nextdns.io
          DNSOverTLS=yes

    - path: /etc/rancher/k3s/config.yaml
      mode: 0644
      overwrite: true
      contents:
        inline: |
          write-kubeconfig-mode: "0640"
          write-kubeconfig-group: wheel
          kubelet-arg:
            - resolv-conf=/run/systemd/resolve/resolv.conf
{% endif %}

    - path: /etc/yum.repos.d/tailscale.repo
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [tailscale-stable]
          name=Tailscale stable
          baseurl=https://pkgs.tailscale.com/stable/fedora/$basearch
          enabled=1
          type=rpm
          repo_gpgcheck=1
          gpgcheck=1
          gpgkey=file:///etc/pki/rpm-gpg/tailscale.gpg

    - path: /etc/sudoers.d/010-sfroeber
      mode: 0440
      overwrite: true
      contents:
        inline: |
          sfroeber ALL=(ALL) NOPASSWD: ALL

{% if is_control_plane %}
    - path: /etc/profile.d/k3s.sh
      mode: 0644
      overwrite: true
      contents:
        inline: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
{% endif %}

  directories:
    - path: /etc/systemd/resolved.conf.d
      mode: 0755
    - path: /var/lib/tailscale
      mode: 0755
      user: { id: 0 }
      group: { id: 0 }

  links:
    - path: /etc/resolv.conf
      target: ../run/systemd/resolve/stub-resolv.conf
      hard: false
      overwrite: true

systemd:
  units:
    - name: firewalld.service
      mask: true
      enabled: false

    - name: serial-getty@ttyS0.service
      mask: true
      enabled: false

    - name: NetworkManager-wait-online.service
      enabled: true

    - name: systemd-resolved.service
      enabled: true

    - name: rpm-ostree-firstboot.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer qemu-guest-agent and tailscale on first boot, then reboot
        Wants=network-online.target NetworkManager-wait-online.service
        After=network-online.target NetworkManager-wait-online.service
        ConditionPathExists=!/var/lib/rpm-ostree-firstboot.stamp
        Before=install-k3s.service

        [Service]
        Type=oneshot
        ExecStartPre=/usr/bin/bash -lc 'for i in {1..60}; do ping -c1 -W1 1.1.1.1 >/dev/null 2>&1 && getent hosts pkgs.tailscale.com >/dev/null 2>&1 && exit 0; sleep 1; done; echo "network/dns not ready"; exit 1'
        ExecStartPre=/usr/bin/bash -lc '[ -f /etc/pki/rpm-gpg/tailscale.gpg ] || (curl -fsSL https://pkgs.tailscale.com/stable/fedora/repo.gpg -o /etc/pki/rpm-gpg/tailscale.gpg && chmod 0644 /etc/pki/rpm-gpg/tailscale.gpg)'
        ExecStart=/usr/bin/rpm-ostree install --allow-inactive --assumeyes qemu-guest-agent tailscale
        ExecStart=/usr/bin/touch /var/lib/rpm-ostree-firstboot.stamp
        ExecStart=/usr/bin/systemctl reboot

        [Install]
        WantedBy=multi-user.target

    - name: install-k3s.service
      enabled: true
      contents: |
        [Unit]
        Description=Install k3s node
        Wants=network-online.target NetworkManager-wait-online.service
        After=network-online.target NetworkManager-wait-online.service rpm-ostree-firstboot.service
        ConditionPathExists=/var/lib/rpm-ostree-firstboot.stamp
        ConditionPathExists=!/var/lib/install-k3s.stamp

        [Service]
        Type=oneshot
        ExecStartPre=/usr/bin/bash -lc 'for i in {1..60}; do getent hosts get.k3s.io >/dev/null 2>&1 && exit 0; sleep 1; done; echo "dns not resolving get.k3s.io"; exit 1'
{% if is_bootstrap %}
        Environment="INSTALL_K3S_EXEC=server --disable traefik --cluster-init --token {{ proxmox_k3s_cluster_token }}"
{% elif is_control_plane %}
        Environment="INSTALL_K3S_EXEC=server --disable traefik --server https://{{ proxmox_k3s_control_plane_start_ip }}:6443 --token {{ proxmox_k3s_cluster_token }}"
{% elif is_worker %}
        Environment="INSTALL_K3S_EXEC=agent --server https://{{ proxmox_k3s_control_plane_start_ip }}:6443 --token {{ proxmox_k3s_cluster_token }}"
{% endif %}
        ExecStart=/usr/bin/sh -c 'curl -sfL https://get.k3s.io | sh -'
        ExecStart=/usr/bin/touch /var/lib/install-k3s.stamp
        ExecStart=/usr/bin/systemctl reboot
        RemainAfterExit=yes

        [Install]
        WantedBy=multi-user.target

    - name: qemu-guest-agent.service
      enabled: true

    - name: tailscaled.service
      enabled: true

    - name: tailscale-up.service
      enabled: true
      contents: |
        [Unit]
        Description=Authenticate Tailscale once
        Wants=network-online.target NetworkManager-wait-online.service
        After=network-online.target NetworkManager-wait-online.service systemd-resolved.service tailscaled.service
        Requires=tailscaled.service
        ConditionPathExists=/var/lib/rpm-ostree-firstboot.stamp
        ConditionPathExists=!/var/lib/tailscale/.authed

        [Service]
        Type=oneshot
        ExecStartPre=/usr/bin/bash -lc 'for i in {1..30}; do systemctl is-active --quiet tailscaled && exit 0; sleep 1; done; echo "tailscaled not active"; exit 1'
        Environment="TS_AUTHKEY={{ lookup('community.general.onepassword', 'Tailscale', field='coachlight-homelab auth key', vault='HomeLab') }}"
        ExecStart=/usr/bin/tailscale up --ssh --authkey=${TS_AUTHKEY} --hostname=%H --accept-routes=true --force-reauth=false --operator=sfroeber{% if tailscale_advertise_tags | default([]) | length > 0 %} --advertise-tags={{ tailscale_advertise_tags | join(',') }}{% endif %}
        ExecStartPost=/usr/bin/touch /var/lib/tailscale/.authed
        Restart=on-failure
        RestartSec=10s

        [Install]
        WantedBy=multi-user.target
