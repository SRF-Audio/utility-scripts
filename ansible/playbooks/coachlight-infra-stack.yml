- name: Deploy Coachlight HomeLab Infra Stack into k3s cluster
  hosts: local
  gather_facts: true
  tags: coachlight_infra_stack_deploy

  pre_tasks:
    - name: Import k3s_kubeconfig_retriever role
      ansible.builtin.import_role:
        name: k3s_kubeconfig_retriever

    - name: Import kubeconfig_manager role
      ansible.builtin.import_role:
        name: kubeconfig_manager
      vars:
        kubeconfig_manager_source_kubeconfig_path: "{{ k3s_kubeconfig_retriever_artifacts.local_output_path }}"
        kubeconfig_manager_cluster_name: "{{ k3s_cluster_name }}"
        kubeconfig_manager_cluster_server: "{{ k3s_api_server_url }}"
        kubeconfig_manager_context_name: "{{ k3s_context_name }}"
        kubeconfig_manager_context_user: "{{ k3s_user_name }}"

    - name: Import k8s_validator role
      ansible.builtin.import_role:
        name: k8s_validator
      vars:
        k8s_validator_kubeconfig: "{{ kubeconfig_manager_artifacts.target_kubeconfig_path }}"
        k8s_validator_context: "{{ kubeconfig_manager_artifacts.context_name }}"

    - name: Add control-plane taints to control-plane nodes
      kubernetes.core.k8s_taint:
        kubeconfig: "{{ kubeconfig_manager_artifacts.target_kubeconfig_path }}"
        context: "{{ kubeconfig_manager_artifacts.context_name }}"
        state: present
        name: "{{ item }}"
        taints:
          - key: "node-role.kubernetes.io/control-plane"
            value: "true"
            effect: "NoSchedule"
      loop: "{{ groups['k3s_control_plane'] | default([]) }}"

    - name: Label k3s nodes with Longhorn zone topology
      kubernetes.core.k8s_json_patch:
        kubeconfig: "{{ kubeconfig_manager_artifacts.target_kubeconfig_path }}"
        context: "{{ kubeconfig_manager_artifacts.context_name }}"
        kind: Node
        name: "{{ item.name }}"
        patch:
          - op: add
            path: /metadata/labels/topology.kubernetes.io~1zone
            value: "{{ item.proxmox_node }}"
      loop: "{{ proxmox_cluster_layout.control_planes + proxmox_cluster_layout.workers }}"
      loop_control:
        label: "{{ item.name }}"

  roles:
    - role: argocd_deploy
      vars:
        argocd_deploy_kubeconfig: "{{ kubeconfig_manager_artifacts.target_kubeconfig_path }}"
        argocd_deploy_context: "{{ kubeconfig_manager_artifacts.context_name }}"
        argocd_deploy_cluster_name: "{{ kubeconfig_manager_artifacts.cluster_name }}"
    - role: tailscale_operator_deploy
      vars:
        tailscale_operator_deploy_kubeconfig: "{{ kubeconfig_manager_artifacts.target_kubeconfig_path }}"
        tailscale_operator_deploy_context: "{{ kubeconfig_manager_artifacts.context_name }}"
        tailscale_operator_deploy_cluster_name: "{{ kubeconfig_manager_artifacts.cluster_name }}"
        tailscale_operator_deploy_oauth_client_id: "{{ tailscale_oauth_client_id }}"
        tailscale_operator_deploy_oauth_client_secret: "{{ tailscale_oauth_client_secret }}"
    - role: synology_csi_deploy
      vars:
        k8s_validator_kubeconfig: "{{ kubeconfig_manager_artifacts.target_kubeconfig_path }}"
        k8s_validator_context: "{{ kubeconfig_manager_artifacts.context_name }}"
    - role: homepage_deploy
    - role: argocd_api_auth
      vars:
        argocd_api_auth_username: "{{ argocd_admin_username }}"
        argocd_api_auth_password: "{{ argocd_admin_password }}"
