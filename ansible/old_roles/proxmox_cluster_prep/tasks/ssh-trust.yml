- name: Pull coachlight-homelab keypair from 1Password
  ansible.builtin.set_fact:
    proxmox_cluster_prep_clh_public: >-
      {{ lookup('community.general.onepassword',
                'coachlight-homelab SSH key',
                vault='HomeLab',
                field='public key') }}
    proxmox_cluster_prep_clh_private: >-
      {{ lookup('community.general.onepassword',
                'coachlight-homelab SSH key',
                vault='HomeLab',
                field='private key') }}
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Check if private key file exists
  ansible.builtin.stat:
    path: ~/.ssh/coachlight-homelab.pem
  register: proxmox_cluster_prep_coachlight_key_stat
  delegate_to: localhost
  run_once: true

- name: Read existing private key if present
  ansible.builtin.slurp:
    src: ~/.ssh/coachlight-homelab.pem
  when: proxmox_cluster_prep_coachlight_key_stat.stat.exists
  register: proxmox_cluster_prep_existing_key_content
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Write private key when missing or content differs
  ansible.builtin.copy:
    dest: ~/.ssh/coachlight-homelab.pem
    content: "{{ proxmox_cluster_prep_clh_private }}"
    mode: "0600"
  when:
    - not proxmox_cluster_prep_coachlight_key_stat.stat.exists or
      (proxmox_cluster_prep_existing_key_content.content | b64decode) !=
      proxmox_cluster_prep_clh_private
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Ensure /root/.ssh exists on every node
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    mode: "0700"
    owner: root
    group: root
  become: true

- name: Install cluster private key as /root/.ssh/id_ed25519
  ansible.builtin.copy:
    src: "/home/sfroeber/.ssh/coachlight-homelab.pem"
    dest: /root/.ssh/id_ed25519
    mode: "0600"
    owner: root
    group: root
  become: true
  no_log: true

- name: Tell root which identity to use for cluster peers
  community.general.ssh_config:
    host: coachlight-homelab-*
    user: root
    identity_file: /root/.ssh/id_ed25519
    identities_only: true
    state: present
  become: true
  when: inventory_hostname in groups['proxmox']
